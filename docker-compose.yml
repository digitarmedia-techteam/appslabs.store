version: '3.8'

services:
  appslabs:
    container_name: appslabs-prod
    build:
      context: .
      dockerfile: Dockerfile
      # If you need valid build-time variables (like NEXT_PUBLIC_), pass them here
      # args:
      #   NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    restart: always
    ports:
      - "3009:3009"

    # Load all environment variables from the .env file
    env_file:
      - .env

    # Explicitly set critical production variables
    environment:
      - NODE_ENV=production
      - PORT=3009
      - HOSTNAME=0.0.0.0

    # Healthcheck to ensure zero-downtime deployments
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3009" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - appslabs_network

    # Optimize logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  appslabs_network:
    driver: bridge
